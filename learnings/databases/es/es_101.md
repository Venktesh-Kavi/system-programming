# Elasticsearch [WIP]

ES = Lucene under the hood

## Document Storage
Not just key-value:
- Rich objects (dates, arrays, geo)
- Stored as documents
- Auto-indexed

## Search Types

1. Basic (_search):
   - Top 10 by default
   - Returns in hits{}

2. Full Text:
```
GET /index/_search
{
  "query": { "match": { "field": "value" }}
}
```

3. Exact Phrase:
```
GET /index/_search
{
  "query": { "match_phrase": { "field": "value" }}
}
```

4. With Highlights:
```
GET /index/_search
{
  "query": { "match": { "field": "value" }},
  "highlight": { "fields": { "field": {} }}
}
```

## Cluster Setup

Master Node:
- Manages cluster ops only
- No doc operations
- Not a bottleneck

Health:
- Green = all good
- Yellow = primary ok, some replicas down
- Red = some primary down

Sharding:
- Each shard = mini Lucene instance
- Primary (fixed) vs Replica (flexible)
- Default = 5 primary shards
- Max docs = Integer.MAX_VALUE - 128

Node Discovery:
- Unicast (prod): list known hosts
  ```
  discovery.zen.ping.unicast.hosts: ["host1", "host2"]
  ```
- Multicast (dev only)

## Document Ops

Metadata:
_index = where stored
_type = object class
_id = unique ID

Updates:
- No in-place changes
- Always reindex/replace
- Version control automatic
- Soft deletes first

Bulk API:
```
POST /_bulk
{"index":{"_index":"test"}}
{"field":"value"}
```

## Search Details

1. Exact Match:
   - Dates, IDs
   - Case sensitive
   - 2014 â‰  2014-01-01

2. Full Text:
   - Natural language
   - Fuzzy match
   - UK = "United Kingdom"
   - jump = jumped, jumping

## Performance
- Batch updates
- Tune refresh_interval
- Use time-based indices
- Watch shard size

## Terms
- Node = ES instance
- Cluster = Node group
- Index = Database
- Document = JSON object
- Shard = Data chunk